# ğŸ·ï¸ Sistema de Etiquetado Menu Cluvi - Label Studio

Sistema de etiquetado NER para descripciones de menÃº usando Label Studio con importaciÃ³n de CSV.

## ğŸ“‹ Contenido

- [Requisitos](#requisitos)
- [InstalaciÃ³n](#instalaciÃ³n)
- [Uso](#uso)
- [ConfiguraciÃ³n del Proyecto](#configuraciÃ³n-del-proyecto)
- [GestiÃ³n de Backups](#gestiÃ³n-de-backups)
- [Exportar Resultados](#exportar-resultados)
- [Invitar Anotadores](#invitar-anotadores)
- [Comandos Ãštiles](#comandos-Ãºtiles)
- [SoluciÃ³n de Problemas](#soluciÃ³n-de-problemas)

---

## ğŸ› ï¸ Requisitos

- Docker
- Docker Compose
- Python 3.8+
- pip (para instalar dependencias Python)
- (Opcional) virtualenv/venv para aislar dependencias

---

## ğŸš€ InstalaciÃ³n

### 1. Clonar y preparar el proyecto

```bash
# Estructura de carpetas
mkdir -p data/raw data/process exports scripts backups
```

### 1.b (Opcional) Crear y activar entorno virtual

```bash
# Crear entorno virtual (recomendado)
python3 -m venv .venv

# Activar el entorno virtual
source .venv/bin/activate

# Alternativa: usar el ayudante para detectar/activar entornos
source ./activate_env.sh
```

### 1.c Instalar dependencias Python

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

Nota: estas dependencias se usan principalmente para los scripts de preparaciÃ³n de datos y utilidades locales. Label Studio corre con Docker.

### 2. Preparar el CSV (OPCIONAL)

Si tu CSV tiene muchos registros, debes limitarlos.

### 2.b Configurar variables de entorno (.env)

Crea un archivo `.env` en la raÃ­z del proyecto con:

```bash
LABEL_STUDIO_PORT=8080
LABEL_STUDIO_ADMIN_USERNAME=admin@example.com
LABEL_STUDIO_ADMIN_PASSWORD=tu_contraseÃ±a_segura
```

### 3. Iniciar Label Studio

```bash
docker-compose up -d
```

### 4. Acceder a Label Studio

```
http://localhost:8080
```

**Credenciales:**
- Email: (la que configuraste en `.env`)
- Password: (la que configuraste en `.env`)

---

## ğŸ“Š ConfiguraciÃ³n del Proyecto

### PASO 1: Crear Proyecto

1. Click en **"Create Project"**
2. Nombre: `Etiquetado Menu`
3. Click **"Save"**

### PASO 2: Importar CSV

1. Click en **"Import"** (o Settings â†’ Import)
2. Click en **"Upload Files"**
3. Selecciona tu archivo preparado: `data/process/cluvi_preprocessed_sampled.csv` (o `data/process/cluvi_preprocessed_sampled.json`)
4. Click **"Import"**

âš ï¸ **Importante:** Si el CSV tiene separador `;`, Label Studio puede tener problemas. AsegÃºrate de usar comas (`,`).

### PASO 3: Configurar Interfaz de Etiquetado

1. Settings â†’ **"Labeling Interface"**
2. Borra todo y pega esta configuraciÃ³n:

```xml
<View>
  <Style>
    .header-main { color: #4CAF50; font-weight: bold; font-size: 1.5em; margin-bottom: 10px; }
    .header-step { color: #2196F3; font-weight: bold; font-size: 1.2em; margin: 20px 0 10px; }
    .header-sub { color: #333; font-weight: bold; font-size: 1.1em; margin-top: 15px; }
    .tip { color: #666; font-style: italic; font-size: 0.9em; padding: 10px; background: #f5f5f5; border-radius: 4px; margin: 10px 0; }
    .success { color: #4CAF50; font-weight: bold; text-align: center; padding: 15px; background: #e8f5e9; border-radius: 8px; margin: 20px 0; }
    .attributes-box { background: #f9f9f9; padding: 15px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #2196F3; }
  </Style>

  <!-- Main Header -->
  <Header value="Â¡Bienvenido/a a Anotar MenÃºs! ğŸ½ï¸" className="header-main"/>
  <Header value="Etiqueta platos, bebidas y mÃ¡s. Sigue los pasos, Â¡es sÃºper fÃ¡cil! ğŸ˜Š" size="4" style="color: #666;"/>

  <!-- Step 1: Review Menu -->
  <Header value="Paso 1: Revisa el MenÃº" className="header-step"/>
  <View className="tip">
    <Header value="ğŸ’¡ Consejo: Selecciona solo las palabras exactas que representen la entidad completa (ej. 'Pizza Margherita' como PLATO, no solo 'Pizza'). Evita solapamientos y asegÃºrate de que cada entidad sea independiente." size="5"/>
  </View>
  <View style="display: flex; flex-direction: column; gap: 10px;">
    <Text name="text" value="TÃ­tulo: $label&#10;DescripciÃ³n: $description&#10;CategorÃ­a: $category&#10;CategorÃ­a Principal: $main_category" granularity="word"/>
    <Labels name="entities" toName="text" smart="true" showInline="true">
      <Label value="INGREDIENTE" background="#FFB6B6"/>
      <Label value="PLATO" background="#B2DFDB"/>
      <Label value="BEBIDA" background="#BBDEFB"/>
      <Label value="MARCA" background="#FFE0B2"/>
    </Labels>
  </View>

  <!-- Step 2: Add Attributes to Entities -->
  <Header value="Paso 2: Agrega Atributos a las Entidades" className="header-step"/>

  <!-- Attributes for PLATO -->
  <View visibleWhen="region-selected" whenTagName="entities" whenLabelValue="PLATO" className="attributes-box">
    <Header value="âš™ï¸ Atributos para PLATO:" className="header-sub"/>
    <Header value="Tipo de Plato" size="5" className="header-sub"/>
    <Choices name="course_type" toName="text" perRegion="true" choice="single" showInline="true">
      <Choice value="Entrante"/>
      <Choice value="Plato Principal"/>
      <Choice value="AcompaÃ±amiento"/>
      <Choice value="Postre"/>
    </Choices>
    <View className="tip">
      <Header value="ğŸ’¡ Consejo: Basado en el contexto del menÃº, elige el tipo que mejor encaje. Por ejemplo, usa 'Entrante' para aperitivos ligeros y 'Plato Principal' para platos fuertes." size="5"/>
    </View>
  </View>

  <!-- Attributes for BEBIDA -->
  <View visibleWhen="region-selected" whenTagName="entities" whenLabelValue="BEBIDA" className="attributes-box">
    <Header value="âš™ï¸ Atributos para BEBIDA:" className="header-sub"/>
    <Header value="Tipo de Bebida" size="5" className="header-sub"/>
    <Choices name="beverage_type" toName="text" perRegion="true" choice="single" showInline="true">
      <Choice value="AlcohÃ³lica"/>
      <Choice value="No AlcohÃ³lica"/>
    </Choices>
    <Header value="CategorÃ­a de Bebida" size="5" className="header-sub"/>
    <Choices name="beverage_category" toName="text" perRegion="true" choice="single" showInline="true">
      <Choice value="Destilados"/>
      <Choice value="Vinos"/>
      <Choice value="Cervezas"/>
      <Choice value="CÃ³cteles"/>
      <Choice value="Gaseosas"/>
      <Choice value="Jugos y Bebidas Naturales"/>
      <Choice value="CafÃ© o TÃ©"/>
      <Choice value="Otro"/>
    </Choices>
    <View className="tip">
      <Header value="ğŸ’¡ Consejo: Usa 'Tipo de Bebida' para clasificar si es alcohÃ³lica o no (ej. 'Cerveza' â†’ AlcohÃ³lica). Para 'CategorÃ­a', elige la mÃ¡s especÃ­fica: 'Gaseosas' para bebidas carbonatadas comerciales (ej. 'Coca-Cola'), 'Jugos y Bebidas Naturales' para jugos frescos o smoothies (ej. 'Jugo de naranja'), 'CafÃ© o TÃ©' para infusiones (ej. 'Capuchino'). Usa 'Otro' para casos como agua pura." size="5"/>
    </View>
  </View>

  <!-- Attributes for INGREDIENTE -->
  <View visibleWhen="region-selected" whenTagName="entities" whenLabelValue="INGREDIENTE" className="attributes-box">
    <Header value="âš™ï¸ Atributos para INGREDIENTE:" className="header-sub"/>
    <Header value="MÃ©todo de CocciÃ³n" size="5" className="header-sub"/>
    <Choices name="cooking_method" toName="text" perRegion="true" choice="multiple" showInline="true">
      <Choice value="Asado"/>
      <Choice value="Frito"/>
      <Choice value="Hervido"/>
      <Choice value="Crudo"/>
      <Choice value="Horneado"/>
      <Choice value="Al Vapor"/>
      <Choice value="Ahumado"/>
      <Choice value="Tostado"/>
      <Choice value="A la Plancha"/>
      <Choice value="Salteado"/>
      <Choice value="No Aplica"/>
    </Choices>
    <Header value="Estado de PreparaciÃ³n" size="5" className="header-sub"/>
    <Choices name="preparation_state" toName="text" perRegion="true" choice="single" showInline="true">
      <Choice value="Crudo"/>
      <Choice value="Cocido"/>
      <Choice value="Procesado"/>
      <Choice value="Mezclado"/>
      <Choice value="Fresco"/>
      <Choice value="Congelado"/>
      <Choice value="No Aplica"/>
    </Choices>
    <View className="tip">
      <Header value="ğŸ’¡ Consejo: Para ingredientes como 'tomate fresco', elige 'Fresco' en Estado y 'Crudo' en MÃ©todo si no se cocina. Selecciona mÃºltiples mÃ©todos si aplica (ej. 'Frito' y 'Ahumado'). Usa 'No Aplica' para estados Ãºnicos." size="5"/>
    </View>
  </View>

  <!-- Attributes for MARCA -->
  <View visibleWhen="region-selected" whenTagName="entities" whenLabelValue="MARCA" className="attributes-box">
    <Header value="âš™ï¸ Atributos para MARCA:" className="header-sub"/>
    <Header value="Tipo de Marca" size="5" className="header-sub"/>
    <Choices name="brand_type" toName="text" perRegion="true" choice="single" showInline="true">
      <Choice value="Marca de Comida"/>
      <Choice value="Marca de Bebida"/>
      <Choice value="Marca de Producto"/>
    </Choices>
    <View className="tip">
      <Header value="ğŸ’¡ Consejo: Elige 'Marca de Comida' para marcas como 'NestlÃ©' en alimentos, 'Marca de Bebida' para 'Coca-Cola'. Usa 'Marca de Producto' para marcas no estÃ¡ndar y describe su categorÃ­a." size="5"/>
    </View>
  </View>

  <!-- Step 3: Complete Metadata -->
  <Header value="Paso 3: Completa los Metadatos" className="header-step"/>
  <Collapse accordion="true">
    <Panel value="ğŸ“‹ Metadatos del MenÃº">
      <View style="padding: 15px;">
        <Header value="Cocina de Origen" size="5" className="header-sub"/>
        <Choices name="origin_cuisine" toName="text" choice="multiple" showInline="true" required="true">
          <Choice value="Italiana"/>
          <Choice value="Peruana"/>
          <Choice value="Japonesa"/>
          <Choice value="Colombiana"/>
          <Choice value="Mexicana"/>
          <Choice value="BrasileÃ±a"/>
          <Choice value="Argentina"/>
          <Choice value="EspaÃ±ola"/>
          <Choice value="AsiÃ¡tica"/>
          <Choice value="FusiÃ³n"/>
          <Choice value="Otra"/>
        </Choices>
        <View className="tip">
          <Header value="ğŸ’¡ Consejo: Identifica el tipo de menÃº revisando platos e ingredientes (ej. 'Pasta' sugiere Italiana). Selecciona mÃºltiples si es fusiÃ³n, o 'Otra' para cocinas no listadas." size="5"/>
        </View>
        <Header value="Idioma del MenÃº" size="5" className="header-sub"/>
        <Choices name="language" toName="text" choice="single" showInline="true" required="true">
          <Choice value="EspaÃ±ol"/>
          <Choice value="InglÃ©s"/>
          <Choice value="PortuguÃ©s"/>
          <Choice value="FrancÃ©s"/>
          <Choice value="Italiano"/>
          <Choice value="Otro"/>
        </Choices>
      </View>
    </Panel>
  </Collapse>

  <!-- Final Message -->
  <View className="success">
    <Header value="âœ¨ Â¡Ãšltimo paso! Revisa que todas las entidades tengan atributos correctos y consistentes. Â¡Lo hiciste genial! âœ¨" size="4"/>
  </View>
</View>
```

3. Click **"Save"**

---

## ğŸ’¾ GestiÃ³n de Backups

### Backups AutomÃ¡ticos

Los backups se ejecutan automÃ¡ticamente **3 veces al dÃ­a** (6 AM, 2 PM, 10 PM) y se guardan en la carpeta `./backups/`.

### Ejecutar Backup Manual

```bash
./scripts/backup.sh
```

Este comando realiza un backup inmediato sin detener los servicios.

### Restaurar desde Backup

```bash
./scripts/restore.sh
```

Este script te permite:
1. Ver todos los backups disponibles
2. Elegir el mÃ¡s reciente o seleccionar uno especÃ­fico
3. Restaurar los datos (con confirmaciÃ³n de seguridad)
4. Reiniciar automÃ¡ticamente los servicios

**Flujo:**
- Detiene los contenedores
- Elimina el volumen actual
- Restaura los datos del backup
- Reinicia los servicios

âš ï¸ **Advertencia:** La restauraciÃ³n elimina todos los datos actuales. AsegÃºrate de seleccionar el backup correcto.

### UbicaciÃ³n de Backups

```
./backups/
â”œâ”€â”€ label-studio-backup-20240115_060000.tar.gz
â”œâ”€â”€ label-studio-backup-20240115_140000.tar.gz
â”œâ”€â”€ label-studio-backup-20240115_220000.tar.gz
â””â”€â”€ backup.log
```

Los backups se conservan durante 30 dÃ­as y se limpian automÃ¡ticamente despuÃ©s.

---

## ğŸ“¤ Exportar Resultados

### Desde la UI

1. En el proyecto, click en **"Export"**
2. Selecciona formato: **JSON** o **CSV**
3. Click **"Export"**

### Formato de ExportaciÃ³n

Los resultados incluirÃ¡n:
- Entidades etiquetadas (INGREDIENTE, PLATO, BEBIDA, MARCA)
- Atributos de cada entidad
- Metadatos del menÃº (cocina de origen, idioma)

---

## ğŸ‘¥ Invitar Anotadores

1. Click en **"Organization"** â†’ **"Members"**
2. Click **"Add Member"**
3. Email del anotador
4. Rol: **"Annotator"** (solo etiquetan, NO configuran)
5. Click **"Send Invitation"**

**Notas:**
- Solo Admins pueden crear proyectos y eliminar datos
- Los Annotators solo pueden etiquetar
- La invitaciÃ³n se envÃ­a por correo

---

## ğŸ”§ Comandos Ãštiles

```bash
# Ver logs de Label Studio
docker-compose logs -f labelstudio

# Ver logs del servicio de backup
docker-compose logs -f backup

# Ver estado de todos los servicios
docker-compose ps

# Reiniciar Label Studio
docker-compose restart labelstudio

# Detener todo sin eliminar datos
docker-compose down

# Detener y eliminar datos (âš ï¸ cuidado)
docker-compose down -v

# Limpiar contenedores huÃ©rfanos
docker-compose down --remove-orphans
```

---

## ğŸ“ Estructura del Proyecto

```
.
â”œâ”€â”€ docker-compose.yml              # ConfiguraciÃ³n Docker
â”œâ”€â”€ .env                            # Variables de entorno (crear)
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ backup.sh                   # Script de backup manual
â”‚   â””â”€â”€ restore.sh                  # Script de restauraciÃ³n
â”œâ”€â”€ backups/                        # Backups automÃ¡ticos (creado automÃ¡ticamente)
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ raw/                        # Datos fuente (entrada)
â”‚   â”‚   â”œâ”€â”€ cluvi_preprocessed.csv
â”‚   â”‚   â”œâ”€â”€ cluvi_preprocessed.json
â”‚   â”‚   â””â”€â”€ cluvi_preprocessed.parquet
â”‚   â””â”€â”€ process/                    # Datos preparados para Label Studio
â”‚       â”œâ”€â”€ cluvi_preprocessed_sampled.csv
â”‚       â”œâ”€â”€ cluvi_preprocessed_sampled.json
â”‚       â””â”€â”€ cluvi_preprocessed_sampled.parquet
â”œâ”€â”€ exports/                        # Resultados exportados por Label Studio
â””â”€â”€ README.md                       # Esta guÃ­a
```

---

## âš ï¸ Notas Importantes

### Separador de CSV

Label Studio espera CSVs con **coma (`,`)** como separador. Si tu archivo usa punto y coma (`;`), conviÃ©rtelo primero.

### Columnas para etiquetar

AsegÃºrate de que tu CSV tenga las siguientes columnas:
- `label`: TÃ­tulo del plato
- `description`: DescripciÃ³n del plato
- `category`: CategorÃ­a del plato
- `main_category`: CategorÃ­a principal

El sistema combinarÃ¡ automÃ¡ticamente estas columnas en un solo texto para etiquetar. Si tus columnas tienen otros nombres, ajusta las referencias `$label`, `$description`, `$category`, y `$main_category` en la configuraciÃ³n XML.

---

## ğŸš¨ SoluciÃ³n de Problemas

### Label Studio no inicia

```bash
docker-compose logs -f labelstudio
```

Revisa si hay errores en los logs. Problema comÃºn: puerto 8080 en uso.

### PÃ¡gina en blanco

- Limpia la cachÃ© del navegador (Ctrl+Shift+Del)
- Accede directamente a: `http://localhost:8080/user/login/`
- Reinicia el contenedor: `docker-compose restart`

### Advertencia de contenedores huÃ©rfanos

```
WARNING: Found orphan containers (label-studio-db)
```

Ejecuta:
```bash
docker-compose down --remove-orphans
docker-compose up -d
```

Esto sucede cuando eliminas servicios del `docker-compose.yml` pero sus contenedores siguen existiendo.

### Problemas con permisos en backups

Si ves errores de permisos al restaurar, asegÃºrate de que los scripts sean ejecutables:

```bash
chmod +x scripts/backup.sh
chmod +x scripts/restore.sh
```

---

## ğŸ“š Recursos

- [DocumentaciÃ³n Label Studio](https://labelstud.io/guide/)
- [Label Studio API](https://labelstud.io/api/)
- [GuÃ­a de Etiquetado NER](https://labelstud.io/templates/named_entity.html)
- [Docker Compose Documentation](https://docs.docker.com/compose/)

---

## ğŸ“ Soporte

Para problemas o dudas:
1. Revisa los logs: `docker-compose logs -f`
2. Consulta la documentaciÃ³n oficial
3. Verifica que todos los archivos estÃ©n en su lugar
4. AsegÃºrate de que los permisos de los scripts sean correctos